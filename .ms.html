<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>.ms</title>
<style>
	body, input, button { font-size: 12px; font-family: monospace; font-weight: bold; }
	button { width: 20px; height: 20px; padding: 0px; }
</style>
<form id="form" method="post">
	<label for="height">Height</label>
	<input type="number" name="height" id="height" />
	<label for="length">Length</label>
	<input type="number" name="length" id="length" />
	<label for="mines">Mines</label>
	<input type="number" name="mines" id="mines" />
	<input type="button" onclick="setTable()" value="Start">
</form>
<script>
	const NBSP = "\u00A0", FLAG = "\uD83D\uDEA9", MINE = "\uD83D\uDCA3"

	let height, length, mines, endCounter, blocks = []

	function setTable() {
		height = document.getElementById("form").height.value
		length = document.getElementById("form").length.value
		mines = document.getElementById("form").mines.value
		endCounter = height * length - mines

		if (endCounter <= 0) {
			alert("This configuration is not possible.\nIncrease height and/or length or decrease amount of mines.")
			return false
		} else
			document.getElementById("form").remove()

		for (let i = 0; i < height; i++) {
			let row = []

			for (let j = 0; j < length; j++)
				row.push({ mine: false, sum: 0 })
			
			blocks.push(row)
		}

		let table = document.createElement("table")
		table.style = "margin: auto;"

		for (let i = 0; i < height; i++) {
			let tr = document.createElement("tr")
			table.appendChild(tr)

			for (let j = 0; j < length; j++) {
				let td = document.createElement("td")
				tr.appendChild(td)
				
				blocks[i][j]["button"] = document.createElement("button")
				blocks[i][j].button.textContent = NBSP
				blocks[i][j].button.style = "background-color: #CCCA;"

				blocks[i][j].button.onclick = () => leftClick(i, j)
				
				blocks[i][j].button.oncontextmenu = () => {
					rightClick(i, j)
					return false
				}

				td.appendChild(blocks[i][j].button)
			}
		}

		document.body.appendChild(table)
	}

	function firstClick(row, col) {
		while (mines) {
			let h = Math.floor(Math.random() * height), l = Math.floor(Math.random() * length)

			if (!blocks[h][l].mine && h !== row && l !== col) {
				blocks[h][l].mine = true
				mines--

				for (let block of surroundings(h, l))
					blocks[block.row][block.col].sum++
			}
		}
	}

	function leftClick(row, col) {
		if (blocks[row][col].button.textContent === NBSP) {
			if (endCounter === height * length - mines)
				firstClick(row, col)

			if (blocks[row][col].mine) {
				blocks[row][col].button.textContent = MINE
				blocks[row][col].button.style = colorPicker(blocks[row][col].sum) + "background-color: red;"
				alert("\u2620    Click ok to restart    \u2620")
				location.reload()
			} else {
				blocks[row][col].button.textContent = blocks[row][col].sum
				blocks[row][col].button.style = colorPicker(blocks[row][col].sum) + "background-color: silver;"
				endCounter--

				if (!endCounter) {
					alert("\uD83D\uDE0E    Click ok to play again    \uD83D\uDE0E")
					location.reload()
				}
			}

			if (blocks[row][col].sum === 0 && !blocks[row][col].mine)
				for (let block of surroundings(row, col))
					if (!blocks[block.row][block.col].mine)
						leftClick(block.row, block.col)
		}
	}

	function rightClick(row, col) {
		if (blocks[row][col].button.textContent !== NBSP && blocks[row][col].button.textContent !== FLAG) {
			let checkFlagsMines = 0

			for (let block of surroundings(row, col))
				if (blocks[block.row][block.col].button.textContent === FLAG)
					checkFlagsMines++

			if (checkFlagsMines === blocks[row][col].sum)
				for (let block of surroundings(row, col))
					leftClick(block.row, block.col)
			
		} else
			blocks[row][col].button.textContent = (blocks[row][col].button.textContent === NBSP) ? FLAG : NBSP
	}

	function surroundings(row, col) {
		let surroundingBlocks = []
		
		for (let i = -1; i < 2; i++)
			for (let j = -1; j < 2; j++)
				if (row + i >= 0 && col + j >= 0 && row + i < height && col + j < length && (i !== 0 || j !== 0))
					surroundingBlocks.push({ row: row + i, col: col + j })

		return surroundingBlocks
	}

	function colorPicker(number) {
		switch(number) {
			case 1: return "color: blue;"
			case 2: return "color: green;"
			case 3: return "color: red;"
			case 4: return "color: navy;"
			case 5: return "color: maroon;"
			case 6: return "color: teal;"
			case 7: return "color: black;"
			case 8: return "color: gray;"
			default: return "color: silver;"
		}
	}
</script>
