<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>.ms</title>
<meta name="description" content="JavaScript Minesweeper">
<style>
	body, input, button { font-size: 2.2vh; font-family: 'Courier New', Courier, monospace; font-weight: bold; color: black; }
	button { width: 3.5vh; height: 3.5vh; padding: 0vh; }
	body { display: flex; flex-direction: column; justify-content: center; min-height: 96vh; text-align: center; background-color: gray; }
	header, main, footer { margin: auto; }
	header, footer { padding: 1vh; }
	input { margin-top: 0.1vh; margin-bottom: 0.1vh; }
	.wt { color: white; }
</style>
<body onload="setForm(false)">
	<header>
		<h1>
			.<span class="wt">ms</span><br>
			JavaScript<br>
			<span class="wt">Minesweeper</span>
		</h1>
	</header>
	<main id="main"></main>
	<footer><a href="https://github.com/6gb/.ms" class="wt">GitHub</a></footer>
</body>
<script>
	const NBSP = "\u00A0", FLAG = "\uD83D\uDEA9", MINE = "\uD83D\uDCA3"

	let height, length, mines, endCounter, blocks = []
	
	function setForm(notFirst) {
		if (notFirst)
			document.getElementById("table").remove()

		let form = document.createElement("form")
		form.id = "form"
		form.method = "post"

		let inputs = [
			document.createElement("input"),
			document.createElement("input"),
			document.createElement("input"),
			document.createElement("input")
		]

		function addParams(input, params) { Object.keys(params).forEach(i => input.setAttribute(i, params[i])); }

		addParams(inputs[0], { type: "number", name: "height", id: "height", placeholder: "Height", value: height, min: 1 })
		addParams(inputs[1], { type: "number", name: "length", id: "length", placeholder: "Length", value: length, min: 1 })
		addParams(inputs[2], { type: "number", name: "mines", id: "mines", placeholder: "Mines", value: mines, min: 1 })
		addParams(inputs[3], { type: "button", onclick: "setTable()", value: "Start" })

		for (let input of inputs) {
			form.appendChild(input)
			form.appendChild(document.createElement("br"))
		}

		document.getElementById("main").appendChild(form);
	}

	function setTable(form) {
		height = document.getElementById("form").height.value
		length = document.getElementById("form").length.value
		mines = document.getElementById("form").mines.value
		endCounter = height * length - mines

		if (endCounter <= 0) {
			alert("This configuration is not possible.\nIncrease height and/or length or decrease amount of mines.")
			return false
		} else
			document.getElementById("form").remove()

		let bs = []

		for (let i = 0; i < height; i++) {
			let row = []

			for (let j = 0; j < length; j++)
				row.push({ mine: false, sum: 0 })

			bs.push(row)
		}

		blocks = bs

		let table = document.createElement("table")
		table.id = "table"
		table.style = "margin: auto;"

		for (let i = 0; i < height; i++) {
			let tr = document.createElement("tr")
			table.appendChild(tr)

			for (let j = 0; j < length; j++) {
				let td = document.createElement("td")
				tr.appendChild(td)

				blocks[i][j]["button"] = document.createElement("button")
				blocks[i][j].button.textContent = NBSP
				blocks[i][j].button.style = "background-color: #CCC !important;"

				blocks[i][j].button.onclick = () => leftClick(i, j)

				blocks[i][j].button.oncontextmenu = () => {
					rightClick(i, j)
					return false
				}

				td.appendChild(blocks[i][j].button)
			}
		}

		let caption = document.createElement("caption")
		
		let flagCounter = document.createElement("flagCounter")
		flagCounter.setAttribute("id", "flagCounter");
		flagCounter.innerHTML = mines
		
		caption.appendChild(flagCounter)
		caption.innerHTML += "\uD83D\uDEA9"
		
		table.appendChild(caption)

		document.getElementById("main").appendChild(table)
	}

	function firstClick(row, col) {
		let ms = mines

		while (ms) {
			let h = Math.floor(Math.random() * height), l = Math.floor(Math.random() * length)

			if (!blocks[h][l].mine && h !== row && l !== col) {
				blocks[h][l].mine = true
				ms--

				for (let block of surroundings(h, l))
					blocks[block.row][block.col].sum++
			}
		}
	}

	function leftClick(row, col) {
		if (blocks[row][col].button.textContent === NBSP) {
			if (endCounter === height * length - mines)
				firstClick(row, col)

			if (blocks[row][col].mine) {
				blocks[row][col].button.textContent = MINE
				blocks[row][col].button.style = colorPicker(blocks[row][col].sum) + "background-color: red;"
				alert(":(    Click ok to restart    ):")
				setForm(true)
			} else {
				blocks[row][col].button.textContent = blocks[row][col].sum
				blocks[row][col].button.style = colorPicker(blocks[row][col].sum) + "background-color: #999 !important;"
				endCounter--

				if (!endCounter) {
					alert("(:    Click ok to play again    :)")
					setForm(true)
				}
			}

			if (blocks[row][col].sum === 0 && !blocks[row][col].mine)
				for (let block of surroundings(row, col))
					if (!blocks[block.row][block.col].mine)
						leftClick(block.row, block.col)
		}
	}

	function rightClick(row, col) {
		if (blocks[row][col].button.textContent !== NBSP && blocks[row][col].button.textContent !== FLAG) {
			let checkFlagsMines = 0

			for (let block of surroundings(row, col))
				if (blocks[block.row][block.col].button.textContent === FLAG)
					checkFlagsMines++

			if (checkFlagsMines === blocks[row][col].sum)
				for (let block of surroundings(row, col))
					leftClick(block.row, block.col)

		} else {
			(blocks[row][col].button.textContent === NBSP) ? document.getElementById("flagCounter").innerHTML-- : document.getElementById("flagCounter").innerHTML++
			
			blocks[row][col].button.textContent = (blocks[row][col].button.textContent === NBSP) ? FLAG : NBSP
		}
	}

	function surroundings(row, col) {
		let surroundingBlocks = []

		for (let i = -1; i < 2; i++)
			for (let j = -1; j < 2; j++)
				if (row + i >= 0 && col + j >= 0 && row + i < height && col + j < length && (i !== 0 || j !== 0))
					surroundingBlocks.push({ row: row + i, col: col + j })

		return surroundingBlocks
	}
	
	function colorPicker(number) {
		switch(number) {
			case 1: return "color: blue;"
			case 2: return "color: green;"
			case 3: return "color: red;"
			case 4: return "color: navy;"
			case 5: return "color: maroon;"
			case 6: return "color: teal;"
			case 7: return "color: black;"
			case 8: return "color: silver;"
			default: return "color: #999 !important;"
		}
	}
</script>
